<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataCapturing - PersistenceLayer</title>
    <link rel="stylesheet" type="text/css" href="/ios-backend/all.css" media="all" />
</head>
<body>
    <header>
        <a href="/ios-backend/">
            <strong>
                DataCapturing
            </strong>
            <span>Documentation</span>
        </a>
    </header>

    <!--
    <form class="search">
        <input type="search" placeholder="Search" />
    </form>
    -->

    <nav>
        <div class="wrapper">
            <h2>On This Page</h2>
            <ol><li><a href="#initializers">Initializers</a><ul><li class="initializer"><a href="#persistencelayer.init(onmanager:withdistancecalculator:)">init(on​Manager:​with​Distance​Calculator:​)</a></li></ul></li><li><a href="#properties">Properties</a><ul><li class="variable"><a href="#persistencelayer.context">context</a></li></ul></li><li><a href="#methods">Methods</a><ul><li class="function"><a href="#persistencelayer.createevent(of:withvalue:)">create​Event(of:​with​Value:​)</a></li><li class="function"><a href="#persistencelayer.delete(measurement:)">delete(measurement:​)</a></li><li class="function"><a href="#persistencelayer.delete(event:)">delete(event:​)</a></li><li class="function"><a href="#persistencelayer.load(measurementidentifiedby:)">load(measurement​Identified​By:​)</a></li><li class="function"><a href="#persistencelayer.loadmeasurements()">load​Measurements()</a></li><li class="function"><a href="#persistencelayer.loadclean(track:)">load​Clean(track:​)</a></li><li class="function"><a href="#persistencelayer.loadsynchronizablemeasurements()">load​Synchronizable​Measurements()</a></li><li class="function"><a href="#persistencelayer.loadevents(typed:formeasurement:)">load​Events(typed:​for​Measurement:​)</a></li><li class="function"><a href="#persistencelayer.countmeasurements()">count​Measurements()</a></li><li class="function"><a href="#persistencelayer.countgeolocations(formeasurement:)">count​Geo​Locations(for​Measurement:​)</a></li><li class="function"><a href="#persistencelayer.makecontext()">make​Context()</a></li><li class="function"><a href="#persistencelayer.collectgeolocations(from:)">collect​Geo​Locations(from:​)</a></li><li class="function"><a href="#persistencelayer.extractidentifiers(from:)">extract​Identifiers(from:​)</a></li><li class="function"><a href="#persistencelayer.traversetracks(ofmeasurement:call:)">traverse​Tracks(of​Measurement:​call:​)</a></li></ul></li></ol>
        </div>
    </nav>

    <main>
        <article>
            <h1>
    <small>Class</small>
    <code class="name">Persistence​Layer</code>
</h1>

<div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">class</span> <span class="type">PersistenceLayer</span>  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>An instance of an object of this class is a wrapper around the CoreData data storage used by the capturing service. It allows CRUD operations on measurements, geo locations and accelerations.</p>

</div>
<div class="discussion">
    <p>All entities produced by a <code>PersistenceLayer</code> are not thread save and thus should not be used outside the calling thread.
If multiple calls to this API are necessary, it is necessary to set an <code>NSManagedObjectContext</code> for the property <code>PersistenceLayer.context</code>.
The creation of this context needs to be carried out on the same thread as the API calls.</p>

<p>A valid usage pattern is to create a new <code>PersistenceLayer</code> instance as part of a custom method accessing the data storage and initialize the API. Using a <code>PersistenceLayer</code> as global state can result in strange errors resulting from CoreData.</p>

<p>Read access is public while manipulation of the data stored is restricted to the framework.</p>

<aside class="author" title="Author">
    <p>Klemens Muthmann</p>

</aside>
<aside class="version" title="Version">
    <p>6.1.1</p>

</aside>
<aside class="since" title="Since">
    <p>1.0.0</p>

</aside>
</div>

    <section id="initializers">
        <h2>Initializers</h2>

        <div role="article" class="initializer" id="persistencelayer.init(onmanager:withdistancecalculator:)">
    <h3>
        <code><a href="#persistencelayer.init(onmanager:withdistancecalculator:)">init(on​Manager:​with​Distance​Calculator:​)</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">init</span>(<span class="variable">onManager</span> <span class="variable">manager</span>: <a href="/ios-backend/CoreDataManager"><span class="type">CoreDataManager</span></a>, <span class="variable">withDistanceCalculator</span>: <a href="/ios-backend/DistanceCalculationStrategy"><span class="type">DistanceCalculationStrategy</span></a> = <span class="variable">DefaultDistanceCalculationStrategy</span>())  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Public constructor usable by external callers.</p>

</div>
<h4>Parameters</h4>

<table class="parameters">
  <thead hidden>
  <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
  </tr>
  </thead>
  <tbody>
    <tr>
    <th>with​Distance​Calculator</th>
    <td><code class="type">Distance​Calculation​Strategy</code></td>
    <td><p>An algorithm used to calculate the distance between geo locations.</p>
</td>
</tr>
<tr>
    <th>manager</th>
    <td><code class="type">Core​Data​Manager</code></td>
    <td><p>A manager for the CoreData stack use by this <code>PersistenceLayer</code>.</p>
</td>
</tr>
  </tbody>
</table>
</div>
    </section>
    <section id="properties">
        <h2>Properties</h2>

        <div role="article" class="variable" id="persistencelayer.context">
    <h3>
        <code><a href="#persistencelayer.context">context</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">var</span> <span class="variable">context</span>: <span class="type">NSManagedObjectContext</span>? </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>The current <code>NSManagedObjectContext</code> used by this persistence layer. This has to be reset if the layer is used on a different thread. If it is <code>nil</code> each method is going to use its own context, which can cause problems if model objects are used between those methods.</p>

</div>
</div>
    </section>
    <section id="methods">
        <h2>Methods</h2>

        <div role="article" class="function" id="persistencelayer.createevent(of:withvalue:)">
    <h3>
        <code><a href="#persistencelayer.createevent(of:withvalue:)">create​Event(of:​with​Value:​)</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">func</span> <span class="function">createEvent</span>(<span class="variable">of</span> <span class="variable">type</span>: <a href="/ios-backend/EventType"><span class="type">EventType</span></a>, <span class="variable">withValue</span>: <span class="type">String</span>? = <span class="keyword">nil</span>) -&gt; <a href="/ios-backend/Event"><span class="type">Event</span></a>  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Creates a new <code>Event</code> at the current time.</p>

</div>
<h4>Parameters</h4>

<table class="parameters">
  <thead hidden>
  <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
  </tr>
  </thead>
  <tbody>
    <tr>
    <th>of</th>
    <td><code class="type">Event​Type</code></td>
    <td><p>The type of the logged <code>Event</code>.</p>
</td>
</tr>
<tr>
    <th>with​Value</th>
    <td><code class="type">String?</code></td>
    <td><p>An optional value providing further information about the event</p>
</td>
</tr>
  </tbody>
</table>
</div>
<div role="article" class="function" id="persistencelayer.delete(measurement:)">
    <h3>
        <code><a href="#persistencelayer.delete(measurement:)">delete(measurement:​)</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">func</span> <span class="function">delete</span>(<span class="variable">measurement</span>: <span class="type">Int64</span>) <span class="keyword">throws</span>  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Deletes the measurement from the data storag.</p>

</div>
<h4>Parameters</h4>

<table class="parameters">
  <thead hidden>
  <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
  </tr>
  </thead>
  <tbody>
    <tr>
    <th>measurement</th>
    <td><code class="type">Int64</code></td>
    <td><p>The measurement to delete from the data storage.</p>
</td>
</tr>
  </tbody>
</table>
  <h4>Throws</h4>
  <ul>
<li><code>PersistenceError</code> If the measurement to delete was not available.</li>
<li>Some unspecified errors from within CoreData.</li>
<li>Some internal file system error on failure of creating or accessing the accelerations file at the required path.</li>
</ul>

</div>
<div role="article" class="function" id="persistencelayer.delete(event:)">
    <h3>
        <code><a href="#persistencelayer.delete(event:)">delete(event:​)</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">func</span> <span class="function">delete</span>(<span class="variable">event</span>: <a href="/ios-backend/Event"><span class="type">Event</span></a>)  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Deletes one event from the database.</p>

</div>
<h4>Parameters</h4>

<table class="parameters">
  <thead hidden>
  <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
  </tr>
  </thead>
  <tbody>
    <tr>
    <th>event</th>
    <td><code class="type">Event</code></td>
    <td><p>The event to delete</p>
</td>
</tr>
  </tbody>
</table>
</div>
<div role="article" class="function" id="persistencelayer.load(measurementidentifiedby:)">
    <h3>
        <code><a href="#persistencelayer.load(measurementidentifiedby:)">load(measurement​Identified​By:​)</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">func</span> <span class="function">load</span>(<span class="variable">measurementIdentifiedBy</span> <span class="variable">identifier</span>: <span class="type">Int64</span>) <span class="keyword">throws</span> -&gt; <a href="/ios-backend/MeasurementMO"><span class="type">MeasurementMO</span></a>  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Loads the data belonging to the provided <code>measurement</code> in the background an calls <code>onFinishedCall</code> with the data storage representation of that <code>measurement</code>. Using that represenation is not thread safe. Do not use it outside of the handler.</p>

</div>
<h4>Parameters</h4>

<table class="parameters">
  <thead hidden>
  <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
  </tr>
  </thead>
  <tbody>
    <tr>
    <th>measurement​Identified​By</th>
    <td><code class="type">Int64</code></td>
    <td><p>The device wide unique identifier of the measurement to load.</p>
</td>
</tr>
  </tbody>
</table>
  <h4>Throws</h4>
  <ul>
<li><code>PersistenceError</code> If there is no such measurement.</li>
<li>Some unspecified errors from within CoreData.</li>
</ul>

  <h4>Returns</h4>
  <p>The requested measurement as a model object.</p>

</div>
<div role="article" class="function" id="persistencelayer.loadmeasurements()">
    <h3>
        <code><a href="#persistencelayer.loadmeasurements()">load​Measurements()</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">func</span> <span class="function">loadMeasurements</span>() <span class="keyword">throws</span> -&gt; [<a href="/ios-backend/MeasurementMO"><span class="type">MeasurementMO</span></a>]  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Loads all the measurements from the data storage.</p>

</div>
  <h4>Throws</h4>
  <ul>
<li>Some unspecified errors from within CoreData.</li>
</ul>

  <h4>Returns</h4>
  <p>An array of all measurements currently stored on this device.</p>

</div>
<div role="article" class="function" id="persistencelayer.loadclean(track:)">
    <h3>
        <code><a href="#persistencelayer.loadclean(track:)">load​Clean(track:​)</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">func</span> <span class="function">loadClean</span>(<span class="variable">track</span>: <a href="/ios-backend/Track"><span class="type">Track</span></a>) <span class="keyword">throws</span> -&gt; [<a href="/ios-backend/GeoLocationMO"><span class="type">GeoLocationMO</span></a>]  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Provides only the valid locations within a cleaned geo location track. This excludes locations occuring because of geo location jitter and pauses.</p>

</div>
<h4>Parameters</h4>

<table class="parameters">
  <thead hidden>
  <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
  </tr>
  </thead>
  <tbody>
    <tr>
    <th>track</th>
    <td><code class="type">Track</code></td>
    <td><p>The track to load a cleaned track for</p>
</td>
</tr>
  </tbody>
</table>
  <h4>Throws</h4>
  <ul>
<li>Some unspecified error from within CoreData</li>
</ul>

  <h4>Returns</h4>
  <p>The cleaned list of geo locations from that track</p>

</div>
<div role="article" class="function" id="persistencelayer.loadsynchronizablemeasurements()">
    <h3>
        <code><a href="#persistencelayer.loadsynchronizablemeasurements()">load​Synchronizable​Measurements()</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">func</span> <span class="function">loadSynchronizableMeasurements</span>() <span class="keyword">throws</span> -&gt; [<a href="/ios-backend/MeasurementMO"><span class="type">MeasurementMO</span></a>]  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Loads only those measurements that have not been synchronized to a Cyface database yet and that are synchronizable at the moment.</p>

</div>
  <h4>Throws</h4>
  <ul>
<li>Some unspecified errors from within CoreData.</li>
</ul>

  <h4>Returns</h4>
  <p>An array containing all the not synchronized measurements.</p>

</div>
<div role="article" class="function" id="persistencelayer.loadevents(typed:formeasurement:)">
    <h3>
        <code><a href="#persistencelayer.loadevents(typed:formeasurement:)">load​Events(typed:​for​Measurement:​)</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">func</span> <span class="function">loadEvents</span>(<span class="variable">typed</span> <span class="variable">type</span>: <a href="/ios-backend/EventType"><span class="type">EventType</span></a>, <span class="variable">forMeasurement</span> <span class="variable">measurement</span>: <a href="/ios-backend/MeasurementMO"><span class="type">MeasurementMO</span></a>) <span class="keyword">throws</span> -&gt; [<a href="/ios-backend/Event"><span class="type">Event</span></a>]  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Retrieves the list of all events of a certain <code>EventType</code> belonging to a <code>MeasurementMO</code> from the database.</p>

</div>
<h4>Parameters</h4>

<table class="parameters">
  <thead hidden>
  <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
  </tr>
  </thead>
  <tbody>
    <tr>
    <th>typed</th>
    <td><code class="type">Event​Type</code></td>
    <td><p>The <code>EventType</code> to load the <code>Event</code> objects for</p>
</td>
</tr>
<tr>
    <th>for​Measurement</th>
    <td><code class="type">Measurement​MO</code></td>
    <td><p>The <code>MeasurementMO</code> object the loaded <code>Event</code> objects belong to</p>
</td>
</tr>
  </tbody>
</table>
</div>
<div role="article" class="function" id="persistencelayer.countmeasurements()">
    <h3>
        <code><a href="#persistencelayer.countmeasurements()">count​Measurements()</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">func</span> <span class="function">countMeasurements</span>() <span class="keyword">throws</span> -&gt; <span class="type">Int</span>  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Counts the amount of measurements currently stored in the data store.</p>

</div>
  <h4>Throws</h4>
  <ul>
<li>Some unspecified errors from within CoreData.</li>
</ul>

  <h4>Returns</h4>
  <p>The count of measurements currently stored on this device.</p>

</div>
<div role="article" class="function" id="persistencelayer.countgeolocations(formeasurement:)">
    <h3>
        <code><a href="#persistencelayer.countgeolocations(formeasurement:)">count​Geo​Locations(for​Measurement:​)</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">func</span> <span class="function">countGeoLocations</span>(<span class="variable">forMeasurement</span> <span class="variable">measurement</span>: <a href="/ios-backend/MeasurementMO"><span class="type">MeasurementMO</span></a>) <span class="keyword">throws</span> -&gt; <span class="type">Int</span>  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Counts the number of geo locations from a certain measurement.</p>

</div>
<h4>Parameters</h4>

<table class="parameters">
  <thead hidden>
  <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
  </tr>
  </thead>
  <tbody>
    <tr>
    <th>measurement</th>
    <td><code class="type">Measurement​MO</code></td>
    <td><p>The measurement to count the geo locations for</p>
</td>
</tr>
  </tbody>
</table>
  <h4>Returns</h4>
  <p>The count of locations measured in the measurement</p>

</div>
<div role="article" class="function" id="persistencelayer.makecontext()">
    <h3>
        <code><a href="#persistencelayer.makecontext()">make​Context()</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">func</span> <span class="function">makeContext</span>() -&gt; <span class="type">NSManagedObjectContext</span>  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Creates a new background <code>NSManagedObjectContext</code> for the current thread. This can be used to set an appropriate value for the <code>context</code> attribute.</p>

</div>
  <h4>Returns</h4>
  <p>The newly created context.</p>

</div>
<div role="article" class="function" id="persistencelayer.collectgeolocations(from:)">
    <h3>
        <code><a href="#persistencelayer.collectgeolocations(from:)">collect​Geo​Locations(from:​)</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">func</span> <span class="function">collectGeoLocations</span>(<span class="variable">from</span> <span class="variable">measurement</span>: <a href="/ios-backend/MeasurementMO"><span class="type">MeasurementMO</span></a>) <span class="keyword">throws</span> -&gt; [<a href="/ios-backend/GeoLocationMO"><span class="type">GeoLocationMO</span></a>]  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Collects all geo locations from all tracks of a measurement and merges them to a single array.</p>

</div>
<h4>Parameters</h4>

<table class="parameters">
  <thead hidden>
  <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
  </tr>
  </thead>
  <tbody>
    <tr>
    <th>from</th>
    <td><code class="type">Measurement​MO</code></td>
    <td><p>The measurement to collect the geo locations from.</p>
</td>
</tr>
  </tbody>
</table>
  <h4>Throws</h4>
  <ul>
<li><code>SerializationError.missingData</code> If no track data was found.</li>
<li><code>SerializationError.invalidData</code> If the database provided inconsistent and wrongly typed data. Something is seriously wrong in these cases.</li>
</ul>

  <h4>Returns</h4>
  <p>An array containing all the collected geo locations from all tracks of the provided measurement.</p>

</div>
<div role="article" class="function" id="persistencelayer.extractidentifiers(from:)">
    <h3>
        <code><a href="#persistencelayer.extractidentifiers(from:)">extract​Identifiers(from:​)</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">func</span> <span class="function">extractIdentifiers</span>(<span class="variable">from</span> <span class="variable">measurements</span>: [<a href="/ios-backend/MeasurementMO"><span class="type">MeasurementMO</span></a>]) -&gt; [<span class="type">Int64</span>]  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Transforms a list of <code>MeasurementMO</code> objects to a list containing the identifiers.</p>

</div>
<div class="discussion">
    <p>If you want to use a list of <code>MeasurementMO</code> objects between different threads you must reload them on a context appropriate for that thread.
To ease this task, this method can be used to make a collection of measurement identifiers, transfer them to the other thread and reload all the measurements there.</p>

</div>
<h4>Parameters</h4>

<table class="parameters">
  <thead hidden>
  <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
  </tr>
  </thead>
  <tbody>
    <tr>
    <th>from</th>
    <td><code class="type">[Measurement​MO]</code></td>
    <td><p>The array of <code>MeasurementMO</code> instances to extract the identifiers for.</p>
</td>
</tr>
  </tbody>
</table>
  <h4>Returns</h4>
  <p>A collection containing all the device wide unqiue identifiers of the provided measurements.</p>

</div>
<div role="article" class="function" id="persistencelayer.traversetracks(ofmeasurement:call:)">
    <h3>
        <code><a href="#persistencelayer.traversetracks(ofmeasurement:call:)">traverse​Tracks(of​Measurement:​call:​)</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">func</span> <span class="function">traverseTracks</span>(<span class="variable">ofMeasurement</span> <span class="variable">measurement</span>: <a href="/ios-backend/MeasurementMO"><span class="type">MeasurementMO</span></a>, <span class="variable">call</span> <span class="variable">closure</span>: (<a href="/ios-backend/Track"><span class="type">Track</span></a>, <a href="/ios-backend/GeoLocationMO"><span class="type">GeoLocationMO</span></a>) -&gt; <span class="type">Void</span>)  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Traverses all tracks captured as part of a measurement and provides each track and geo location to a callback.</p>

</div>
<h4>Parameters</h4>

<table class="parameters">
  <thead hidden>
  <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
  </tr>
  </thead>
  <tbody>
    <tr>
    <th>of​Measurement</th>
    <td><code class="type">Measurement​MO</code></td>
    <td><p>The measurement to traverse the tracks for</p>
</td>
</tr>
<tr>
    <th>call</th>
    <td><code class="type">(Track, Geo​Location​MO) -&gt; Void</code></td>
    <td><p>A callback function receiving the track and geo location pairs</p>
</td>
</tr>
  </tbody>
</table>
</div>
    </section>



        </article>
    </main>

    <footer>
        <p>
    Generated on <time datetime="2021-09-28T10:34:59+0200">September 28, 2021</time> using <a href="https://github.com/SwiftDocOrg/swift-doc">swift-doc</a> <span class="version">1.0.0-rc.1</span>.
</p>
    </footer>
</body>
</html>
